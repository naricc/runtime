<!-- This project requires an explicit SDK version number because it is used on Helix,
      and global.json is not available. -->
<Project Sdk="Microsoft.Build.NoTargets/1.0.53" DefaultTargets="WasmBuildApp">
  <Import Project="$(CORE_ROOT)\build\WasmApp.InTree.props" />
  <PropertyGroup>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <MicrosoftNetCoreAppRuntimePackDir>$(CORE_ROOT)\runtimepack\</MicrosoftNetCoreAppRuntimePackDir>
    <MicrosoftNetCoreAppRuntimePackRidDir>$(CORE_ROOT)\runtimepack\runtimes\browser-wasm\</MicrosoftNetCoreAppRuntimePackRidDir>
    <TargetFramework>$(NetCoreAppCurrent)</TargetFramework>
    <BuildDir>$(MSBuildThisFileDirectory)\obj\$(Configuration)\wasm</BuildDir>
    <AppDir>$(TestBinDir)/WasmApp/</AppDir>
    <PackageRID>browser-wasm</PackageRID>
    <NETCoreAppMaximumVersion>99.0</NETCoreAppMaximumVersion>
    <WasmAppBuilderTasksAssemblyPath>$(CORE_ROOT)\WasmAppBuilder\WasmAppBuilder.dll</WasmAppBuilderTasksAssemblyPath>
    <MonoAOTCompilerTasksAssemblyPath>$(CORE_ROOT)\MonoAOTCompiler\MonoAOTCompiler.dll</MonoAOTCompilerTasksAssemblyPath>
    <EMSDK_PATH>$(CORE_ROOT)\runtimepack\native\emsdk</EMSDK_PATH>
    <PublishTrimmed>true</PublishTrimmed>
  </PropertyGroup>

  <Target Name="BuildApp" BeforeTargets="WasmBuildApp">
    <PropertyGroup>
      <WasmMainAssemblyFileName>$(TestAssemblyFileName)</WasmMainAssemblyFileName>
      <WasmAppDir>$(AppDir)</WasmAppDir>
      <WasmMainJSPath>$(CORE_ROOT)\runtime-test\runtime-test.js</WasmMainJSPath>
      <WasmResolveAssembliesBeforeBuild>false</WasmResolveAssembliesBeforeBuild>
      <WasmGenerateRunV8Script>true</WasmGenerateRunV8Script>
      <WasmSkipMissingAssemblies>true</WasmSkipMissingAssemblies>
      <AssemblySearchPaths>$(TestBinDir)/publish</AssemblySearchPaths>
    </PropertyGroup>

    <Message Text="!!!naricc_debug!!!: WasmTestRunner: TestBinDir: $(TestBinDir): Corelib: $(MicrosoftNetCoreAppRuntimePackDir)native/System.Private.CoreLib.dll" Importance="high" />

    <ItemGroup>      
      <WasmAssembliesToBundle Include="$(TestBinDir)\publish\*.dll" />
      <WasmAssembliesToBundle Include="$(MicrosoftNetCoreAppRuntimePackDir)native/System.Private.CoreLib.dll" />
    </ItemGroup>

    <Message Importance="High" Text="AppDir: $(AppDir)" />
    <Message Importance="High" Text="TestBinDir: $(TestBinDir)" />
    <Message Importance="High" Text="ArtifactsBinDir: $(ArtifactsBinDir)" />
  </Target>

  <Import Project="$(CORE_ROOT)\build\WasmApp.InTree.targets" />
</Project>
